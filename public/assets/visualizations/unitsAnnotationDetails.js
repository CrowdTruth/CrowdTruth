function unitsAnnotationDetails(category,categoryName,openModal){var urlBase="/api/analytics/piegraph/?match[type][]=workerunit&",annotationDivs=[],queryField='unit_id',categoryPrefix='in',querySettings={metricCateg:'units',metricFilter:['withSpam','withoutSpam'],aggName:"aggUnits",metricFields:['max_relation_Cos'],metricName:['clarity'],metricTooltip:[{key:'CrowdTruth Average Unit Clarity',value:"the value is defined as the maximum unit annotation score achieved on any annotation for that unit. High agreement over the annotations is represented by high cosine scores, indicating a clear unit. Click to select/deselect."}],metricSuffix:".avg"};if(category=='#job_tab'){queryField='job_id';querySettings={annotationMetricFields:['top_ann_cond_prob','cond_prob','annot_ambiguity','cond_prob_minus_rel_prob','mutual_info','annot_prob','annot_top_prob','annot_freq','annot_clarity'],annotationMetricNames:["max P(Rc|Rr-Top)","max P(Rc|Rr)","max Rr->Rc","max P(Rc|Rr)-P(Rc)","max I(Rc,Rd)","P(R)","P(R-Top)","|S:R|","RClar"],pivotTableFields:['top_ann_cond_prob','cond_prob','rel_similarity','cond_prob_minus_rel_prob','mutual_info_dict'],pivotTableNames:["P(Rc|Rr-Top)",'P(Rc|Rr)','Rr->Rc','P(Rc|Rr)-P(Rc)','I(Rc,Rd)']}}else if(category=='#crowdagents_tab'){queryField='crowdAgent_id';querySettings={metricCateg:'workers',metricFilter:['withoutFilter','withFilter'],aggName:'aggWorkers',metricFields:['avg_worker_agreement','worker_cosine'],metricName:['agreement','cosine'],metricSuffix:"",metricTooltip:[{key:'CrowdTruth Average Worker Agreement score',value:'Higher scores indicate better quality workers. Click to select/deselect.'},{key:'CrowdTruth Average Cosine Similarity',value:'Higher Scores indicate better quality workers. Click to select/deselect.'}]};categoryPrefix='from'};var currentSelection=[],currentSelectionInfo={},unitsAnnotationInfo={},activeSelectedPlatform="",activeSelectedType="",pieChart="",callback=function callback($this){var img=$this.renderer.image('/assets/check_mark.png',$this.chartWidth-60,15,19,14);img.add();img.css({cursor:'pointer'});img.attr({title:'Pop out chart'});img.attr("data-toggle","tooltip");img.attr("title","Click to see results without low quality annotations");img.on('click',function(){alert("under construction")});var img=$this.renderer.image('/assets/cross.png',$this.chartWidth-90,16,19,12);img.add();img.css({cursor:'pointer'});img.attr({title:'Pop out chart'});img.attr("data-toggle","tooltip");img.attr("title","Click to see results with low quality annotations");img.on('click',function(){alert("under construction")})},getJobHeatMapData=function(platform,type){var series={};activeSelectedPlatform=platform;activeSelectedType=type;var unitList={},annotationsURL='/api/v1/?field[type][]=job&';for(var indexUnits in currentSelection)annotationsURL+='&field[_id][]='+currentSelection[indexUnits];annotationsURL+='&field[softwareAgent_id][]='+platform;annotationsURL+='&field[type][]='+type;annotationsURL+='&only[]=results&only[]=metrics.units&only[]=metrics.annotations&only[]=metrics.pivotTables.annotations';$.getJSON(annotationsURL,function(data){var heatMapData={};heatMapData.annotations={};heatMapData.avg_clarity={};heatMapData.annotationMetric={};heatMapData.pivotTable={};for(var heatMapCateg in heatMapData){heatMapData[heatMapCateg]['min']=Number.MAX_VALUE;heatMapData[heatMapCateg]['max']=Number.MIN_VALUE;heatMapData[heatMapCateg]['categoryY']=[];heatMapData[heatMapCateg]['indexY']=0;heatMapData[heatMapCateg]['spam']=[];heatMapData[heatMapCateg]['nonSpam']=[];heatMapData[heatMapCateg]['diff']=[]};var indexX=0,allUnits=data[0]['results']['withoutSpam'],mTaksKeys=Object.keys(allUnits[Object.keys(allUnits)[0]]),categories=Object.keys(allUnits[Object.keys(allUnits)[0]][mTaksKeys[0]]);for(var annotationIter in categories){var annotation=categories[annotationIter];for(var heatMapCateg in heatMapData)heatMapData[heatMapCateg]['indexY']=0;for(var iterPivotTable in querySettings.pivotTableFields){var pivotTable=querySettings.pivotTableFields[iterPivotTable];if(!(pivotTable in heatMapData.pivotTable)){heatMapData.pivotTable[pivotTable]={};heatMapData.pivotTable[pivotTable]['min']=Number.MAX_VALUE;heatMapData.pivotTable[pivotTable]['max']=Number.MIN_VALUE;heatMapData.pivotTable[pivotTable]['categoryY']=[];heatMapData.pivotTable[pivotTable]['indexY']=0;heatMapData.pivotTable[pivotTable]['spam']=[];heatMapData.pivotTable[pivotTable]['nonSpam']=[];heatMapData.pivotTable[pivotTable]['diff']=[]};heatMapData.pivotTable[pivotTable]['indexY']=0};for(var iterData in data){var jobID=data[iterData]['_id'],arrayID=jobID.split("/"),jobNb=arrayID[arrayID.length-1];for(var unitID in data[iterData]['results']['withSpam'])for(var taskIter in mTaksKeys){var task=mTaksKeys[taskIter];if(task=='avg')continue;var arrayUnit=unitID.split("/"),unitNb=arrayUnit[arrayUnit.length-1];if(indexX==0){if(mTaksKeys.length>1){heatMapData.annotations['categoryY'].push('unit '+unitNb+'('+task+')'+" in job "+jobNb);heatMapData.avg_clarity['categoryY'].push('unit '+unitNb+'('+task+')'+" in job "+jobNb);unitList[unitID]='unit '+unitNb+'('+task+')'+" in job "+jobNb}else{heatMapData.annotations['categoryY'].push('unit '+unitNb+" in job "+jobNb);heatMapData.avg_clarity['categoryY'].push('unit '+unitNb+" in job "+jobNb);unitList[unitID]='unit '+unitNb+" in job "+jobNb};var spamValue=data[iterData]['metrics']['units']['withSpam'][unitID][task]['max_relation_Cos'],nonSpamValue=data[iterData]['metrics']['units']['withoutSpam'][unitID][task]['max_relation_Cos'];heatMapData.avg_clarity['spam'].push([indexX,heatMapData.avg_clarity['indexY'],spamValue]);heatMapData.avg_clarity['nonSpam'].push([indexX,heatMapData.avg_clarity['indexY'],nonSpamValue]);heatMapData.avg_clarity['diff'].push([indexX,heatMapData.avg_clarity['indexY'],spamValue-nonSpamValue]);if(heatMapData.avg_clarity['max']<spamValue)heatMapData.avg_clarity['max']=spamValue;if(heatMapData.avg_clarity['min']>nonSpamValue)heatMapData.avg_clarity['min']=nonSpamValue;if(heatMapData.avg_clarity['min']>spamValue-nonSpamValue)heatMapData.avg_clarity['min']=spamValue-nonSpamValue;heatMapData.avg_clarity['indexY']+=1};var spamValue=data[iterData]['results']['withSpam'][unitID][task][annotation],nonSpamValue=data[iterData]['results']['withoutSpam'][unitID][task][annotation];heatMapData.annotations['spam'].push([indexX,heatMapData.annotations['indexY'],spamValue]);heatMapData.annotations['nonSpam'].push([indexX,heatMapData.annotations['indexY'],nonSpamValue]);heatMapData.annotations['diff'].push([indexX,heatMapData.annotations['indexY'],spamValue-nonSpamValue]);if(heatMapData.annotations['max']<spamValue)heatMapData.annotations['max']=spamValue;if(heatMapData.annotations['min']>nonSpamValue)heatMapData.annotations['min']=nonSpamValue;if(heatMapData.annotations['min']>spamValue-nonSpamValue)heatMapData.annotations['min']=spamValue-nonSpamValue;heatMapData.annotations['indexY']+=1};for(var iterPivotTable in querySettings.pivotTableFields){var pivotTable=querySettings.pivotTableFields[iterPivotTable];for(var annotationIterY in categories){var annotY=categories[annotationIterY];if(indexX==0)heatMapData.pivotTable[pivotTable]['categoryY'].push(annotY+" in job "+jobNb);var spamValue=0,nonSpamValue=0;if(annotation in data[iterData]['metrics']['pivotTables']['annotations']['withSpam'][pivotTable]){var spamValue=data[iterData]['metrics']['pivotTables']['annotations']['withSpam'][pivotTable][annotY][annotation],nonSpamValue=data[iterData]['metrics']['pivotTables']['annotations']['withoutSpam'][pivotTable][annotY][annotation]};heatMapData.pivotTable[pivotTable]['spam'].push([indexX,heatMapData.pivotTable[pivotTable]['indexY'],spamValue.toFixed(3)]);heatMapData.pivotTable[pivotTable]['nonSpam'].push([indexX,heatMapData.pivotTable[pivotTable]['indexY'],nonSpamValue.toFixed(3)]);heatMapData.pivotTable[pivotTable]['diff'].push([indexX,heatMapData.pivotTable[pivotTable]['indexY'],(spamValue-nonSpamValue).toFixed(3)]);if(heatMapData.pivotTable[pivotTable]['max']<spamValue)heatMapData.pivotTable[pivotTable]['max']=spamValue;if(heatMapData.pivotTable[pivotTable]['min']>nonSpamValue)heatMapData.pivotTable[pivotTable]['min']=nonSpamValue;if(heatMapData.pivotTable[pivotTable]['min']>spamValue-nonSpamValue)heatMapData.pivotTable[pivotTable]['min']=spamValue-nonSpamValue;heatMapData.pivotTable[pivotTable]['indexY']+=1}};if(indexX==0)for(var iterMetrics in querySettings.annotationMetricFields){var metricField=querySettings.annotationMetricFields[iterMetrics];for(var annotationIterY in categories){var annotY=categories[annotationIterY];if(!(metricField in heatMapData.annotationMetric)){heatMapData.annotationMetric[metricField]={};heatMapData.annotationMetric[metricField]['min']=Number.MAX_VALUE;heatMapData.annotationMetric[metricField]['max']=Number.MIN_VALUE;heatMapData.annotationMetric[metricField]['categoryY']=[];heatMapData.annotationMetric[metricField]['indexY']=0;heatMapData.annotationMetric[metricField]['spam']=[];heatMapData.annotationMetric[metricField]['nonSpam']=[];heatMapData.annotationMetric[metricField]['diff']=[]};heatMapData.annotationMetric[metricField]['categoryY'].push(annotY+" in job "+jobNb);var spamValue=data[iterData]['metrics']['annotations']['withSpam'][metricField][annotY],nonSpamValue=data[iterData]['metrics']['annotations']['withoutSpam'][metricField][annotY];heatMapData.annotationMetric[metricField]['spam'].push([indexX,heatMapData.annotationMetric[metricField]['indexY'],spamValue.toFixed(3)]);heatMapData.annotationMetric[metricField]['nonSpam'].push([indexX,heatMapData.annotationMetric[metricField]['indexY'],nonSpamValue.toFixed(3)]);heatMapData.annotationMetric[metricField]['diff'].push([indexX,heatMapData.annotationMetric[metricField]['indexY'],(spamValue-nonSpamValue).toFixed(3)]);if(heatMapData.annotationMetric[metricField]['max']<spamValue)heatMapData.annotationMetric[metricField]['max']=spamValue;if(heatMapData.annotationMetric[metricField]['min']>nonSpamValue)heatMapData.annotationMetric[metricField]['min']=nonSpamValue;if(heatMapData.annotationMetric[metricField]['min']>spamValue-nonSpamValue)heatMapData.annotationMetric[metricField]['min']=spamValue-nonSpamValue;heatMapData.annotationMetric[metricField]['indexY']+=1}}};indexX+=1};var urlUnit='/api/v1/?',legend={},iterUnits=0;for(var keyUnits in unitList){urlUnit+='field[_id]['+iterUnits+']='+keyUnits+'&';iterUnits++};urlUnit+='only[]=content.sentence.formatted';$.getJSON(urlUnit,function(data){var title="Unit clarity",width=(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/5),tooltip=function(){return'<p class = "pieDivGraphs">'+this.series.yAxis.categories[this.point.y]+', '+this.series.xAxis.categories[this.point.x]+' score:<b>'+this.point.value+'</p>'},height=16*heatMapData.avg_clarity['categoryY'].length,min=heatMapData.avg_clarity['min'],max=heatMapData.avg_clarity['max'],colorAxis={stops:[[0,'#3060cf'],[0.5,'#fffbbc'],[0.9,'#c4463a']],min:min,max:max};heatMapGraph(['clarity'],heatMapData.avg_clarity['categoryY'],heatMapData.avg_clarity['nonSpam'],title,'After filtering low quality',colorAxis,'unitsMetricAfter_'+0+'_div',width,height,tooltip,false);annotationDivs.push('unitsMetricAfter_'+0+'_div');heatMapGraph(['clarity'],heatMapData.avg_clarity['categoryY'],heatMapData.avg_clarity['spam'],title,'Before filtering low quality',colorAxis,'unitsMetricBefore_'+0+'_div',width,height,tooltip,false);annotationDivs.push('unitsMetricBefore_'+0+'_div');heatMapGraph(['clarity'],heatMapData.avg_clarity['categoryY'],heatMapData.avg_clarity['diff'],title,'low - high quality metrics',colorAxis,'unitsMetricDiff_'+0+'_div',width,height,tooltip,false);annotationDivs.push('unitsMetricDiff_'+0+'_div');var iterMetrics=0;for(iterMetrics;iterMetrics<querySettings.pivotTableFields.length;iterMetrics++){var metricField=querySettings.annotationMetricFields[iterMetrics],pivotTable=querySettings.pivotTableFields[iterMetrics],title=querySettings.pivotTableNames[iterMetrics]+' of annotations for '+currentSelection.length+' Selected '+categoryName+'(s)',width=(3*(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/5)),tooltip=function(){return'<p class = "pieDivGraphs">'+this.series.yAxis.categories[this.point.y]+' - '+this.series.xAxis.categories[this.point.x]+' score:<b>'+this.point.value+'</p>'},min=heatMapData.pivotTable[pivotTable]['min'],max=heatMapData.pivotTable[pivotTable]['max'];colorAxis={stops:[[0,'#3060cf'],[0.5,'#fffbbc'],[0.9,'#c4463a']],min:min,max:max};var height=16*heatMapData.pivotTable[pivotTable]['categoryY'].length;heatMapGraph(categories,heatMapData.pivotTable[pivotTable]['categoryY'],heatMapData.pivotTable[pivotTable]['nonSpam'],title,'After filtering low quality',colorAxis,'pivotTableAfter_'+iterMetrics+'_div',width,height,tooltip,true);annotationDivs.push('pivotTableAfter_'+iterMetrics+'_div');heatMapGraph(categories,heatMapData.pivotTable[pivotTable]['categoryY'],heatMapData.pivotTable[pivotTable]['spam'],title,'Before filtering low quality',colorAxis,'pivotTableBefore_'+iterMetrics+'_div',width,height,tooltip,true);annotationDivs.push('pivotTableBefore_'+iterMetrics+'_div');heatMapGraph(categories,heatMapData.pivotTable[pivotTable]['categoryY'],heatMapData.pivotTable[pivotTable]['diff'],title,'low - high quality metrics',colorAxis,'pivotTableDiff_'+iterMetrics+'_div',width,height,tooltip,true);annotationDivs.push('pivotTableDiff_'+iterMetrics+'_div');var title=querySettings.annotationMetricNames[iterMetrics],width=(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/5),height=16*heatMapData.annotationMetric[metricField]['categoryY'].length,min=heatMapData.annotationMetric[metricField]['min'],max=heatMapData.annotationMetric[metricField]['max'];colorAxis={stops:[[0,'#3060cf'],[0.5,'#fffbbc'],[0.9,'#c4463a']],min:min,max:max};heatMapGraph(title,heatMapData.annotationMetric[metricField]['categoryY'],heatMapData.annotationMetric[metricField]['nonSpam'],title,'After filtering low quality',colorAxis,'annotationsMetricAfter_'+iterMetrics+'_div',width,height,tooltip,false);annotationDivs.push('annotationsMetricAfter_'+iterMetrics+'_div');heatMapGraph(title,heatMapData.annotationMetric[metricField]['categoryY'],heatMapData.annotationMetric[metricField]['spam'],title,'Before filtering low quality',colorAxis,'annotationsMetricBefore_'+iterMetrics+'_div',width,height,tooltip,false);annotationDivs.push('annotationsMetricBefore_'+iterMetrics+'_div');heatMapGraph(title,heatMapData.annotationMetric[metricField]['categoryY'],heatMapData.annotationMetric[metricField]['diff'],title,'low - high quality metrics',colorAxis,'annotationsMetricDiff_'+iterMetrics+'_div',width,height,tooltip,false);annotationDivs.push('annotationsMetricDiff_'+iterMetrics+'_div')};var noMetrics=querySettings.annotationMetricFields.length-iterMetrics,middleIter=noMetrics/2+iterMetrics-1;for(iterMetrics;iterMetrics<querySettings.annotationMetricFields.length;iterMetrics++){var metricField=querySettings.annotationMetricFields[iterMetrics],title=querySettings.annotationMetricNames[iterMetrics],width=(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/(noMetrics+1)),height=16*heatMapData.annotationMetric[metricField]['categoryY'].length,min=heatMapData.annotationMetric[metricField]['min'],max=heatMapData.annotationMetric[metricField]['max'];colorAxis={stops:[[0,'#3060cf'],[0.5,'#fffbbc'],[0.9,'#c4463a']],min:min,max:max};var show=false;if(iterMetrics==middleIter){show=true;var width=(2*(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/(noMetrics+1)))};heatMapGraph(title,heatMapData.annotationMetric[metricField]['categoryY'],heatMapData.annotationMetric[metricField]['nonSpam'],title,'After filtering low quality',colorAxis,'annotationsMetricAfter_'+iterMetrics+'_div',width,height,tooltip,show);annotationDivs.push('annotationsMetricAfter_'+iterMetrics+'_div');heatMapGraph(title,heatMapData.annotationMetric[metricField]['categoryY'],heatMapData.annotationMetric[metricField]['spam'],title,'Before filtering low quality',colorAxis,'annotationsMetricBefore_'+iterMetrics+'_div',width,height,tooltip,show);annotationDivs.push('annotationsMetricBefore_'+iterMetrics+'_div');heatMapGraph(title,heatMapData.annotationMetric[metricField]['categoryY'],heatMapData.annotationMetric[metricField]['diff'],title,'low - high quality metrics',colorAxis,'annotationsMetricDiff_'+iterMetrics+'_div',width,height,tooltip,show);annotationDivs.push('annotationsMetricDiff_'+iterMetrics+'_div')};var title='Aggregated view of  annotations of '+currentSelection.length+' Selected '+categoryName+'(s)',width=(3*(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/5)),tooltip=function(){return'<b>'+this.series.xAxis.categories[this.point.x]+'</b> got <b>'+this.point.value+'</b> annotations '+categoryPrefix+' <b>'+this.series.yAxis.categories[this.point.y]+'</b>'},min=heatMapData.annotations['min'],max=heatMapData.annotations['max'],height=16*heatMapData.annotations['categoryY'].length,colorAxisAnnotations={min:min,max:max,minColor:'#fffbbc',maxColor:'#3060cf'};for(var iterDataUrl in data){var unitInfoID=data[iterDataUrl]['_id'];legend[unitList[unitInfoID]]=data[iterDataUrl]['content']['sentence']['formatted']};heatMapGraph(categories,heatMapData.annotations['categoryY'],heatMapData.annotations['nonSpam'],title,'High quality annotations.',colorAxisAnnotations,'annotationsAfter_div',width,height,tooltip,true,legend);annotationDivs.push('annotationsAfter_div');heatMapGraph(categories,heatMapData.annotations['categoryY'],heatMapData.annotations['spam'],title,'All annotations.',colorAxisAnnotations,'annotationsBefore_div',width,height,tooltip,true,legend);annotationDivs.push('annotationsBefore_div');heatMapGraph(categories,heatMapData.annotations['categoryY'],heatMapData.annotations['diff'],title,'Low quality annotations.',colorAxisAnnotations,'annotationsDiff_div',width,height,tooltip,true,legend);annotationDivs.push('annotationsDiff_div');addTooltipYLabel('#annotationsAfter_div',legend)})})},getHeatMapData=function(platform,type){if(category=='#job_tab'){getJobHeatMapData(platform,type);return};var categories=[],series={};activeSelectedPlatform=platform;activeSelectedType=type;var annotationsURL=urlBase;annotationsURL+='match[softwareAgent_id][]='+platform;if(type!="")annotationsURL+='&match[type][]='+type;annotationsURL+='&project[annotationVector]=annotationVector&project[spam]=spam&project[job_id]=job_id&group='+queryField+'&push[annotationVector]=annotationVector&push[spam]=spam&push[job_id]=job_id';$.getJSON(annotationsURL,function(data){var urlJobsInfo='/api/v1/?field[type]=job&';for(var dataIter in data){var fieldID=data[dataIter]['_id'];series[fieldID]={};for(var iterMetric in querySettings.metricFields){var metricName=querySettings.metricFields[iterMetric],metricFilters=querySettings.metricFilter;for(var iterFilter in metricFilters)urlJobsInfo+='&only[]=metrics.'+querySettings.metricCateg+'.'+metricFilters[iterFilter]+'.'+fieldID+querySettings.metricSuffix+'.'+metricName};for(var iterJob in data[dataIter]['job_id']){var jobID=data[dataIter]['job_id'][iterJob],dataCategory='spam';if(!(jobID in series[fieldID]))series[fieldID][jobID]={};if(data[dataIter]['spam'][iterJob]==false)dataCategory='nonSpam';var annVectors=data[dataIter]['annotationVector'][iterJob];for(var annTaskKey in annVectors){if(categories.length==0)categories=Object.keys(annVectors[annTaskKey]);var missingKeys=false;if(!(dataCategory in series[fieldID][jobID])){missingKeys=true;series[fieldID][jobID]['spam']={};series[fieldID][jobID]['nonSpam']={}};for(var annKey in annVectors[annTaskKey])if(missingKeys){series[fieldID][jobID]['spam'][annKey]=0;series[fieldID][jobID]['nonSpam'][annKey]=0;series[fieldID][jobID][dataCategory][annKey]=annVectors[annTaskKey][annKey]}else series[fieldID][jobID][dataCategory][annKey]+=annVectors[annTaskKey][annKey]}}};var categoriesY=[],heatMapDataAfter=[],heatMapDataBefore=[],heatMapDataDiff=[],indexX=0,legend={},min=Number.MAX_VALUE,max=Number.MIN_VALUE,indexY=0;for(var annotation in categories){indexY=0;for(var worker in series)for(var job in series[worker]){var arrayUnit=worker.split("/"),workerID=arrayUnit[arrayUnit.length-1],arrayUnit=job.split("/"),jobID=arrayUnit[arrayUnit.length-1];if(indexX==0){var categoryYName=categoryName+' '+workerID;if(workerID!=jobID)categoryYName+=' in job '+jobID;categoriesY.push(categoryYName);if(category=='#crowdagents_tab'){legend[categoryYName]={};legend[categoryYName]='Aggregated vector across all the annotated units with this type of annotations'}else{console.dir(currentSelectionInfo);legend[categoryYName]=currentSelectionInfo[worker]['tooltipLegend']['Sentence']}};var afterData=series[worker][job]['nonSpam'][categories[annotation]],beforeData=series[worker][job]['spam'][categories[annotation]];heatMapDataAfter.push([indexX,indexY,afterData]);heatMapDataBefore.push([indexX,indexY,afterData+beforeData]);heatMapDataDiff.push([indexX,indexY,beforeData]);if(max<(afterData+beforeData))max=afterData+beforeData;if(min>afterData)min=afterData;if(min>beforeData)min=beforeData;indexY+=1};indexX+=1};var title='Aggregated view of  annotations of '+currentSelection.length+' Selected '+categoryName+'(s)',width=(3*(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/5)),tooltip=function(){return'<b>'+this.series.xAxis.categories[this.point.x]+'</b> got <b>'+this.point.value+'</b> annotations '+categoryPrefix+' <b>'+this.series.yAxis.categories[this.point.y]+'</b>'},colorAxisAnnotations={min:min,max:max,minColor:'#fffbbc',maxColor:'#3060cf'},height=16*categoriesY.length;console.dir(categoryName);console.dir(currentSelectionInfo);heatMapGraph(categories,categoriesY,heatMapDataAfter,'High quality annotations.',title,colorAxisAnnotations,'annotationsAfter_div',width,height,tooltip,true,legend);annotationDivs.push('annotationsAfter_div');heatMapGraph(categories,categoriesY,heatMapDataBefore,'All annotations.',title,colorAxisAnnotations,'annotationsBefore_div',width,height,tooltip,true,legend);annotationDivs.push('annotationsBefore_div');heatMapGraph(categories,categoriesY,heatMapDataDiff,'Low quality annotations.',title,colorAxisAnnotations,'annotationsDiff_div',width,height,tooltip,true,legend);annotationDivs.push('annotationsDiff_div');var metricsData={};metricsData.spam={};metricsData.nonSpam={};$.getJSON(urlJobsInfo,function(data){for(var iterData in data){var jobID=data[iterData]['_id'],arrayUnit=jobID.split("/"),jobNo=arrayUnit[arrayUnit.length-1];if(!('metrics'in data[iterData]))continue;var jobInfo=data[iterData]['metrics'][querySettings.metricCateg],metricFilters=querySettings.metricFilter;for(var worker in jobInfo[metricFilters[0]])for(var iterMetric in querySettings.metricFields){var metricName=querySettings.metricFields[iterMetric];if(!(metricName in metricsData.spam)){metricsData.spam[metricName]={};metricsData.nonSpam[metricName]={}};var arrayUnit=worker.split("/"),workerID=arrayUnit[arrayUnit.length-1],key=categoryName+' '+workerID+' in job '+jobNo;metricsData.spam[metricName][key]=jobInfo[metricFilters[0]][worker][metricName];if(querySettings.metricSuffix!='')metricsData.spam[metricName][key]=jobInfo[metricFilters[0]][worker]['avg'][metricName];metricsData.nonSpam[metricName][key]=jobInfo[metricFilters[1]][worker][metricName];if(querySettings.metricSuffix!='')metricsData.nonSpam[metricName][key]=jobInfo[metricFilters[1]][worker]['avg'][metricName]}};for(var iterMetric in querySettings.metricFields){var minMetric=Number.MAX_VALUE,maxMetric=Number.MIN_VALUE,metricName=querySettings.metricFields[iterMetric],spamData=[],nonSpamData=[],diffData=[];for(var iterCateg in categoriesY){var y=parseInt(iterCateg),afterData=metricsData.nonSpam[metricName][categoriesY[iterCateg]],beforeData=metricsData.spam[metricName][categoriesY[iterCateg]];spamData.push([0,y,beforeData.toFixed(3)]);nonSpamData.push([0,y,afterData.toFixed(3)]);diffData.push([0,y,(beforeData.toFixed(3)-afterData.toFixed(3)).toFixed(3)]);if(maxMetric<afterData)maxMetric=afterData;if(maxMetric<beforeData)maxMetric=beforeData;if(minMetric>afterData)minMetric=afterData;if(minMetric>beforeData-afterData)minMetric=beforeData-afterData};var title=categoryName+" "+querySettings.metricName[iterMetric],width=((1/querySettings.metricName.length)*(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/5)),colorAxis={stops:[[0,'#3060cf'],[0.5,'#fffbbc'],[0.9,'#c4463a']],min:minMetric,max:maxMetric},tooltip=function(){return'<p class = "pieDivGraphs">'+this.series.yAxis.categories[this.point.y]+', '+this.series.xAxis.categories[this.point.x]+' score:<b>'+this.point.value+'</p>'},height=16*categoriesY.length;heatMapGraph([querySettings.metricName[iterMetric]],categoriesY,nonSpamData,title,'After filtering low quality',colorAxis,'annotationsMetricAfter_'+iterMetric+'_div',width,height,tooltip,false);annotationDivs.push('annotationsMetricAfter_'+iterMetric+'_div');heatMapGraph([querySettings.metricName[iterMetric]],categoriesY,spamData,title,'Before filtering low quality',colorAxis,'annotationsMetricBefore_'+iterMetric+'_div',width,height,tooltip,false);annotationDivs.push('annotationsMetricBefore_'+iterMetric+'_div');heatMapGraph([querySettings.metricName[iterMetric]],categoriesY,diffData,title,'low - high quality metrics',colorAxis,'annotationsMetricDiff_'+iterMetric+'_div',width,height,tooltip,false);annotationDivs.push('annotationsMetricDiff_'+iterMetric+'_div')};addTooltipYLabel('#annotationsAfter_div',legend)})})},addTooltipYLabel=function(divName,legend){var legendItems=$(divName+' .highcharts-yaxis-labels')[0].children;for(var legendItemIter in legendItems){var elemeHTML=$(legendItems[legendItemIter]);elemeHTML.attr('data-toggle','tooltip');var tooltipValue=legend[elemeHTML.text()];elemeHTML.attr('title',tooltipValue)}},drawPieChart=function(platform,spam){pieChart=new Highcharts.Chart({chart:{renderTo:'annotationsPie_div',type:'pie',marginTop:80,width:(1*(($('.maincolumn').width()-0.05*($('.maincolumn').width()))/5)),height:350},title:{style:{fontWeight:'bold'},text:'Type of Annotations of the '+currentSelection.length+' selected  '+categoryName+'(s)'},credits:{enabled:false},subtitle:{text:'Click a category to see the distribution of annotations'},yAxis:{scalable:false,style:{fontWeight:'bold'},title:{text:'Number of workers per unit'}},dataLabels:{enabled:true},plotOptions:{pie:{shadow:false,allowPointSelect:true,center:['50%','50%'],point:{events:{click:function(){var platform=this.options.platform,type="";if('type'in this.options){type=this.options.type;getHeatMapData(platform,type);for(var iterDiv in annotationDivs){var divName=annotationDivs[iterDiv];$('#'+divName).show()}}}}}}},tooltip:{useHTML:true,formatter:function(){var seriesValue=this.key;return'<p><b>'+seriesValue+' </b></br>'+this.series.name+' : '+this.percentage.toFixed(2)+' % ('+this.y+'/'+this.total+')</p>'},followPointer:false,hideDelay:10},series:[{name:'# of annotations',data:platform,size:'40%',dataLabels:{formatter:function(){return this.point.name},color:'white',distance:-30}},{name:'# of annotations',data:spam,size:'60%',innerSize:'40%',dataLabels:{formatter:function(){return this.point.name},color:'black',distance:3}}]})};this.update=function(selectedUnits,selectedInfo){for(var iterDiv in annotationDivs){var divName=annotationDivs[iterDiv];$('#'+divName).hide()};if(selectedUnits.length==0){$('#annotationsPie_div').hide()}else $('#annotationsPie_div').show();activeSelectedPlatform="";activeSelectedType="";currentSelection=selectedUnits;currentSelectionInfo=selectedInfo;urlBase="/api/analytics/piegraph/?match[type][]=workerunit&";for(var indexUnits in selectedUnits)urlBase+='match['+queryField+'][]='+selectedUnits[indexUnits]+'&';platformURL=urlBase+'&project[_id]=_id&group=softwareAgent_id&push[id]=_id';$.getJSON(platformURL,function(data){var platformData=[],categoriesData=[],requests=[],iterColors=0,colors=['#FFC640','#A69C00'];for(var platformIter in data){var platformID=data[platformIter]['_id'];platformData.push({name:platformID,y:data[platformIter]['id'].length,color:Highcharts.Color(colors[platformIter]).brighten(0.07).get(),platform:platformID});unitsAnnotationInfo[platformID]={};unitsAnnotationInfo[platformID]['all']=data[platformIter]['id'];requests.push($.get(urlBase+'match[softwareAgent_id][]='+data[platformIter]['_id']+'&project[_id]=_id&group=type&addToSet=_id'))};var defer=$.when.apply($,requests);defer.done(function(){var platform="",type="";$.each(arguments,function(index,responseData){if($.isArray(responseData)){if(responseData[1]=='success')responseData=responseData[0];for(var iterObj in responseData){categoriesData.push({name:responseData[iterObj]['_id'],type:responseData[iterObj]['_id'],y:responseData[iterObj].content.length,color:Highcharts.Color(colors[index]).brighten(-0.01*iterObj).get(),platform:data[index]['_id']});platform=data[index]['_id'];type=responseData[iterObj]['_id'];unitsAnnotationInfo[platform][type]=responseData[iterObj].content}}});drawPieChart(platformData,categoriesData)})})};this.createUnitsAnnotationDetails=function(){}};;